// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  subscriptions Subscription[]
  offers        Offer[]
  payments      Payment[]
}

model Subscription {
  id                String    @id @default(cuid())
  userId            String
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  stripeCustomerId  String?
  stripeSubscriptionId String? @unique
  status            SubscriptionStatus @default(ACTIVE)
  currentPeriodEnd  DateTime?
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([userId])
  @@index([stripeSubscriptionId])
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
  UNPAID
}

model Property {
  id                String    @id @default(cuid())
  sourceUrl         String    @unique
  sourceType        String    // "zillow", "redfin", etc.
  mlsNumber         String?
  address           String
  city              String
  state             String
  zipCode           String
  price             Float?
  aiFairValue       Float?     // AI-generated fair market value for making reasonable offers
  daysOnMarket      Int?
  propertyType      String?    // "singlefamily", "condo", etc.
  listingAgentName  String?
  listingAgentEmail String?
  listingAgentPhone String?
  offerDeadline     DateTime?
  hasHOA            Boolean?
  builtBefore1978   Boolean?
  extractedData     Json?     // Store any additional extracted data
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  offers            Offer[]

  @@index([sourceUrl])
  @@index([mlsNumber])
}

model Offer {
  id                    String    @id @default(cuid())
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  propertyId            String
  property              Property  @relation(fields: [propertyId], references: [id], onDelete: Cascade)
  
  // User inputs
  financingType         String    // "cash", "conventional", "fha", "va", etc.
  offerPrice            Float
  contingencies         Json      // { inspection: boolean, appraisal: boolean, financing: boolean }
  timelinePreferences   Json?     // User's timeline preferences
  concessions           Json?     // Seller credits and concessions
  additionalNotes       String?
  
  // Offer letter generation
  status                OfferStatus @default(DRAFT)
  offerLetterPreview    String?     // Preview text
  offerLetterUrl        String?     // URL to full offer letter document
  requiresAgentReview   Boolean     @default(false)
  agentReviewStatus     AgentReviewStatus @default(PENDING)
  agentReviewNotes      String?
  reviewedAt            DateTime?
  
  // Email notification
  notificationSent      Boolean   @default(false)
  notificationSentAt    DateTime?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  payments              Payment[]

  @@index([userId])
  @@index([propertyId])
  @@index([status])
}

enum OfferStatus {
  DRAFT
  PENDING_REVIEW
  GENERATED
  DOWNLOADED
  COMPLETED
}

enum AgentReviewStatus {
  PENDING
  REQUESTED
  IN_REVIEW
  APPROVED
  NEEDS_REVISION
  COMPLETED
}

model Payment {
  id                    String    @id @default(cuid())
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  offerId               String?
  offer                 Offer?    @relation(fields: [offerId], references: [id], onDelete: SetNull)
  
  stripePaymentIntentId String?   @unique
  stripeCheckoutSessionId String? @unique
  amount                Float     // Amount in cents
  currency              String    @default("usd")
  status                PaymentStatus @default(PENDING)
  paymentType           PaymentType
  
  // Metadata
  metadata              Json?
  
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  paidAt                DateTime?

  @@index([userId])
  @@index([offerId])
  @@index([stripePaymentIntentId])
  @@index([stripeCheckoutSessionId])
}

enum PaymentStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  REFUNDED
}

enum PaymentType {
  SINGLE_DOWNLOAD
  SINGLE_DOWNLOAD_WITH_REVIEW
  AGENT_REVIEW_ONLY
  MONTHLY_SUBSCRIPTION
  FULL_REPRESENTATION
}

